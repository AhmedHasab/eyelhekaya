<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
  <meta name="googlebot" content="noindex, nofollow">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ุฐูุงุก ุงุฎุชูุงุฑ ุงููุตุต โ ุฅูู ุงูุญูุงูุฉุ</title>

  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="style.css" />

  <meta name="theme-color" content="#ffffff" />
  <link rel="icon" type="image/png" href="Logo_Channel.png">
  <link rel="apple-touch-icon" href="icon-192.png">
</head>

<body>
  <div class="app-container">

    <header class="app-header">
      <h1>๐ฌ ุฐูุงุก ุงุฎุชูุงุฑ ุงููุตุต โ ููุงุฉ "ุฅูู ุงูุญูุงูุฉุ"</h1>

      <div class="top-buttons">
        <button id="btn-pick-today" class="btn primary strong">๐ ุงุฎุชูุงุฑ ูุตุฉ ููุฏูู ุทููู ูููุง ููุชุฑูุฏ</button>
        <button id="btn-pick-long" class="btn primary">๐ฅ ุงุฎุชูุงุฑ ูุตุฉ ุนุดูุงุฆูุฉ ูุณุฌูุฉ ุจุงููููุน (ููุฏูู ุทููู)</button>
        <button id="btn-pick-short" class="btn accent">โก ุงุฎุชูุงุฑ ููุฏูู (ุฑููุฒ) ูู ุงูุชุฑูุฏ</button>
        <button id="btn-update-trends" class="btn secondary">๐ ุชุญุฏูุซ ุงูุชุฑููุฏุงุช</button>
      </div>

      <div class="status-row">
        <span id="status-trends" class="status-pill muted">ุชุฑููุฏุงุช Google ุบูุฑ ูุญุฏุซุฉ</span>
        <span id="status-youtube" class="status-pill muted">ุชุฑููุฏุงุช YouTube ุบูุฑ ูุญุฏุซุฉ</span>
        <span id="status-deaths" class="status-pill muted">ูููุงุช ุขุฎุฑ 48 ุณุงุนุฉ ุบูุฑ ูุญุฏุซุฉ</span>
      </div>

      <div class="layout-controls">
        <button id="btn-show-ai-only" class="btn secondary small">โก ุนุฑุถ ูุชุงุฆุฌ ุงูุฐูุงุก ููุท</button>
        <button id="btn-show-both" class="btn secondary small">โฌ ุนุฑุถ ุงูููุญูู ูุนูุง</button>
        <button id="btn-show-stories-only" class="btn secondary small">โฌ ุนุฑุถ ุฅุฏุงุฑุฉ ุงููุตุต ููุท</button>
      </div>
    </header>

    <main class="main-layout">

      <section class="ai-panel card">
        <h2>๐ง ูุชุงุฆุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู</h2>
        <div id="ai-output" class="ai-output">
          <p>ุงุถุบุท ุนูู ุฃุญุฏ ุงูุฃุฒุฑุงุฑ ุจุงูุฃุนูู ูุจุฏุก ุงูุชุญููู.</p>
        </div>
      </section>

      <section class="stories-panel card">
        <h2>๐ ุฅุฏุงุฑุฉ ุงููุตุต</h2>

        <textarea id="raw-input" rows="5" placeholder="ูุซุงู:
ูููู ูุฑุงุฏ
ูุญุงููุงุช ุงุบุชูุงู ูุจุงุฑู
ุญุงุฏุซุฉ ุทุงุฆุฑุฉ ูุตุฑ ููุทูุฑุงู
..."></textarea><br>

        <label class="block-label">โ๏ธ ุงูุตู ุงููุต ุงูุฎุงู ูููุตุต (ูู ุณุทุฑ = ูุตุฉ):</label><br>

        <button id="btn-parse-raw" class="btn primary small">โ ุชุญููู ุงููุต ุฅูู ูุตุต</button>

        <div class="manual-input-row">

          <div class="manual-cell">
            <label>ุงุณู ุงููุตุฉ</label>
            <textarea id="manual-name" placeholder="ุงูุชุจ ุงุณู ุงููุตุฉ ููุง" rows="2" class="resizable-textarea"></textarea>
          </div>

          <div class="manual-cell">
            <label>ููุน ุงููุตุฉ (Category)</label>
            <button type="button" id="toggle-categories" class="dropdown-btn">ุงุฎุชุฑ ุงููุฆุงุช โผ</button>

            <div id="categories-dropdown" class="categories-dropdown hidden">
              <label><input type="checkbox" value="A">A- ุงููุดุงููุฑ ูุงููุฌูู</label>
              <label><input type="checkbox" value="B">B- ุงูุณูุงุณููู ูุงูุฒุนูุงุก ูุงููุงุฏุฉ</label>
              <label><input type="checkbox" value="C">C- ุงููุฎุงุจุฑุงุช ูุงูุฌูุงุณูุณ</label>
              <label><input type="checkbox" value="D">D- ุงูุฌุฑุงุฆู ูุงูุงุฎุชูุงุกุงุช</label>
              <label><input type="checkbox" value="E">E- ุงูุชุงุฑูุฎ ุงูุนุณูุฑู</label>
              <label><input type="checkbox" value="F">F- ุงูุฃูุจูุงุก ูุงูุตุญุงุจุฉ ูุงูุบุฒูุงุช</label>
              <label><input type="checkbox" value="G">G- ุงูุนููุงุก ูุงููููุฑูู</label>
            </div>

            <small style="opacity:.7">ุงุฎุชุฑ ูุฆุฉ ูุงุญุฏุฉ ุฃู ุฃูุซุฑ</small>
          </div>

          <div class="manual-cell">
            <label>ููุน ุงููุญุชูู</label>

            <label>
              <input type="radio" name="story-type" value="long" checked>
              ๐ฌ ูุตุฉ ุทูููุฉ
            </label>

            <label>
              <input type="radio" name="story-type" value="short">
              โก ูุตุฉ ูุตูุฑุฉ (ุฑููุฒ)
            </label>
          </div>

          <div class="manual-cell">
            <label>ุชููููู ุงูุดุฎุตู (ุงูุฏุฑุฌุฉ)</label>
            <input id="manual-score" type="number" min="0" max="100" value="80" />
          </div>

          <div class="manual-cell">
            <label>ููุงุญุธุงุช / ุฑูุงุจุท</label>
            <textarea id="manual-notes" placeholder="ููุงุญุธุฉ โ ุฑุงุจุท โ ูููุฉ ููุชุงุญูุฉ" rows="4"
              class="resizable-textarea"></textarea>
          </div>

          <div class="manual-cell manual-cell-action">
            <label>&nbsp;</label>
            <button id="btn-add-manual" class="btn primary small">โ ุฅุถุงูุฉ ูุตุฉ ูุฏูููุง</button>
          </div>

        </div>

        <p class="manual-hint">โ ูุชู ุงุญุชุณุงุจ ุชุงุฑูุฎ ุงูุชุณุฌูู ูุฏุฑุฌุฉ ุงูุฐูุงุก ุชููุงุฆููุง.</p>

        <div class="backup-row">
          <button id="btn-export" class="btn secondary small">๐พ ุชุตุฏูุฑ ุงููุตุต</button>

          <label for="import-file" class="btn secondary small file-label">๐ ุงุณุชูุฑุงุฏ ุงููุตุต</label>
          <input type="file" id="import-file" hidden accept="application/json" />
        </div>

        <div class="search-row">
          <label>๐ ุดุฑูุท ุจุญุซ:</label>
          <textarea id="stories-search"
            placeholder="ุจุญุซ ูุตูโฆ ุฃู ุชุงุฑูุฎ: 18/12/2025 ุฃู 18/12/25 ุฃู ูุฏู: 18/12/25 - 20/12/25" rows="2"
            class="resizable-textarea"></textarea>
        </div>

        <button id="btn-show-favorites" class="btn secondary small">โญ ุนุฑุถ ุงูููุถูุฉ</button>

        <button id="btn-force-group" class="btn secondary" type="button">
          ๐งฉ ุชุฌููุน ูุชุดุงุจู (ูุคูุช)
        </button>

        <div class="table-wrapper">
          <table id="stories-table">
            <thead>
              <tr>
                <th>#</th>
                <th>ุงูุงุณู</th>
                <th>ุงูููุน</th>
                <th>ุงูุฏุฑุฌุฉ</th>
                <th>ุงูุฌุงุฐุจูุฉ</th>
                <th>ุฐูุงุก</th>
                <th>ุชูููุฐ</th>
                <th>ุชุงุฑูุฎ</th>
                <th>ููุงุญุธุงุช</th>
                <th>ุชุญูู</th>
              </tr>
            </thead>
            <tbody id="stories-tbody"></tbody>
          </table>
        </div>

      </section>

      <h3 style="margin-top:25px;">โก ุงููุตุต ุงููุตูุฑุฉ (ุฑููุฒ)</h3>

      <div class="table-wrapper">
        <table id="short-stories-table">
          <thead>
            <tr>
              <th>#</th>
              <th>ุงูุงุณู</th>
              <th>ุงูููุน</th>
              <th>ุงูุฏุฑุฌุฉ</th>
              <th>ุงูุฌุงุฐุจูุฉ</th>
              <th>ุฐูุงุก</th>
              <th>ุชูููุฐ</th>
              <th>ุชุงุฑูุฎ</th>
              <th>ููุงุญุธุงุช</th>
              <th>ุชุญูู</th>
            </tr>
          </thead>
          <tbody id="short-stories-tbody"></tbody>
        </table>
      </div>

    </main>
  </div>

  <!-- ========= Helpers (ูุจู app.js) ========= -->
  <script>
    function getDeviceId() {
      let id = localStorage.getItem("EH_DEVICE_ID");
      if (!id) {
        id = crypto.randomUUID();
        localStorage.setItem("EH_DEVICE_ID", id);
      }
      return id;
    }

    async function toggleFavorite(id) {
      await addToFavorites(id);
    }

    function getSelectedStoryType() {
      const el = document.querySelector("input[name='story-type']:checked");
      return el ? el.value : "long";
    }

    function setCategoriesSelection(categories = []) {
      document.querySelectorAll("#categories-dropdown input[type='checkbox']")
        .forEach(cb => { cb.checked = categories.includes(cb.value); });
    }

    function clearCategoriesSelection() {
      document.querySelectorAll("#categories-dropdown input[type='checkbox']")
        .forEach(cb => { cb.checked = false; });
    }

    document.getElementById("toggle-categories")
      ?.addEventListener("click", () => {
        document.getElementById("categories-dropdown")?.classList.toggle("hidden");
      });

    function getSelectedCategories() {
      return Array.from(
        document.querySelectorAll("#categories-dropdown input[type='checkbox']:checked")
      ).map(cb => cb.value);
    }
  </script>

  <!-- ========= app.js ========= -->
  <script src="app.js"></script>

  <!-- =========================================
       FORCE GROUPING + DATE SEARCH (FINAL)
       - ุชุฌููุน ุฅุฌุจุงุฑู ูุคูุช (ุนุฑุถ ููุท)
       - ุจุญุซ ุชุงุฑูุฎ: 18/12/2025 ุฃู 18/12/25
       - ูุฏู: 18/12/25 - 20/12/25
       - ูุง ูุบููุฑ ุชุฑุชูุจ ุงูุณูุฑูุฑ ููุง ูููุณ ุงูุจูุงูุงุช
  ========================================== -->
<script>
/* ================================
   FORCE SMART GROUPING โ WORKING
   modifies STORIES ARRAY DIRECTLY
================================ */

let FORCE_GROUPING = false;

/* 15 ูููุฉ */
function words15(title) {
  return normalizeArabic(title)
    .split(" ")
    .filter(Boolean)
    .slice(0, 15);
}

/* ุนุฏุฏ ุงููููุงุช ุงููุดุชุฑูุฉ */
function overlap(a, b) {
  const A = new Set(words15(a));
  const B = new Set(words15(b));
  let c = 0;
  A.forEach(w => B.has(w) && c++);
  return c;
}

/* ุชุฌููุน ูุนูู */
function groupStories(list) {
  const used = new Set();
  const out = [];

  for (let i = 0; i < list.length; i++) {
    const base = list[i];
    if (used.has(base.id)) continue;

    const group = [base];
    used.add(base.id);

    for (let j = 0; j < list.length; j++) {
      const other = list[j];
      if (used.has(other.id)) continue;

      if (overlap(base.title, other.title) >= 2) {
        group.push(other);
        used.add(other.id);
      }
    }

    group.sort((a, b) =>
      overlap(b.title, base.title) - overlap(a.title, base.title)
    );

    out.push(...group);
  }

  return out;
}

/* ุฒุฑ ุงูุชุฌููุน */
document.getElementById("btn-force-group").addEventListener("click", () => {
  FORCE_GROUPING = !FORCE_GROUPING;

  const base = FORCE_GROUPING
    ? groupStories([...stories])
    : stories;

  renderTableBody(
    document.getElementById("stories-tbody"),
    base.filter(s => (s.type || "long") === "long")
  );

  renderTableBody(
    document.getElementById("short-stories-tbody"),
    base.filter(s => s.type === "short")
  );
});
</script>


  <!-- =========================================
     INLINE ROW REORDER โ SAFE VERSION
  ========================================== -->
  <script>
    (() => {
      const WORKER_URL = "https://odd-credit-25c6.namozg50.workers.dev/";
      let reorderInput = null;

      const UUID_RE =
        /[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}/;

      function removeInput() {
        reorderInput?.remove();
        reorderInput = null;
      }

      function extractStoryId(row) {
        const id = row?.dataset?.storyId;
        if (id && UUID_RE.test(id)) return id;
        return "";
      }

      function renumber(tbody) {
        tbody.querySelectorAll("tr").forEach((tr, i) => {
          const td = tr.querySelector("td");
          if (td) td.textContent = i + 1;
        });
      }

      async function saveReorder(id, toIndex) {
        const res = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "reorder_story",
            payload: {
              id: String(id),
              toIndex: Number(toIndex)
            }
          })
        });

        if (!res.ok) {
          const t = await res.text();
          console.error("โ reorder failed:", t);
          throw new Error("reorder_story rejected");
        }
      }

      document.addEventListener(
        "dblclick",
        async e => {
          const row = e.target.closest("tbody tr");
          if (!row) return;

          e.preventDefault();
          e.stopPropagation();

          const tbody = row.closest("tbody");
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const max = rows.length;

          const storyId = extractStoryId(row);
          if (!storyId) {
            alert("โ ูุฐุง ุงูุตู ูุง ูุญุชูู ุนูู storyId ุตุญูุญ");
            return;
          }

          removeInput();

          reorderInput = document.createElement("input");
          reorderInput.type = "number";
          reorderInput.min = 1;
          reorderInput.max = max;
          reorderInput.placeholder = "ุฑูู ุงูุชุฑุชูุจ";

          const r = row.getBoundingClientRect();
          Object.assign(reorderInput.style, {
            position: "absolute",
            top: `${window.scrollY + r.top}px`,
            left: `${window.scrollX + r.right + 8}px`,
            zIndex: 9999,
            width: "110px",
            padding: "6px",
            borderRadius: "8px"
          });

          document.body.appendChild(reorderInput);
          reorderInput.focus();

          reorderInput.onkeydown = async ev => {
            if (ev.key === "Escape") return removeInput();
            if (ev.key !== "Enter") return;

            const to = Number(reorderInput.value);
            if (!to || to < 1 || to > max) return;

            removeInput();

            const current = Array.from(tbody.querySelectorAll("tr"));
            const target = current[to - 1];

            tbody.removeChild(row);
            tbody.insertBefore(row, target);

            renumber(tbody);

            try {
              await saveReorder(storyId, to);
            } catch {
              alert("โ ูุดู ุญูุธ ุงูุชุฑุชูุจ (ุฑุงุฌุน Console)");
            }
          };
        },
        true
      );

      document.addEventListener("mousedown", e => {
        if (e.target !== reorderInput) removeInput();
      });

      const style = document.createElement("style");
      style.textContent = `
        tbody tr { user-select:none }
        input { user-select:text!important }
      `;
      document.head.appendChild(style);
    })();
  </script>

  <script>
    (function () {
      console.log("โ Cache Override Active");
      window.getCachedAi = () => null;
      window.setCachedAi = () => { };
    })();
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>

  <style>
    .table-wrapper {
      resize: vertical;
      overflow: auto;
      min-height: 420px;
      max-height: 90vh;
    }

    .manual-input-row {
      display: grid;
      grid-template-columns: 2fr 1.2fr 0.6fr 2fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 15px;
    }

    .manual-cell {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .resizable-textarea {
      width: 100%;
      resize: vertical;
      min-height: 42px;
      padding: 8px 10px;
      font-family: inherit;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    #manual-notes {
      min-height: 80px;
    }

    .search-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 10px;
      align-items: center;
      margin: 15px 0;
    }

    #stories-search {
      max-width: 480px;
    }

    .dropdown-btn {
      padding: 6px 12px;
      cursor: pointer;
      border: 1px solid #ccc;
      background: #f7f7f7;
      border-radius: 4px;
    }

    .table-toolbar {
      margin-bottom: 8px;
      display: flex;
      justify-content: flex-start;
    }

    .categories-dropdown {
      margin-top: 6px;
      padding: 10px;
      border: 1px solid #ccc;
      background: #fff;
      max-width: 320px;
    }

    .categories-dropdown label {
      display: block;
      margin: 6px 0;
      cursor: pointer;
    }

    .hidden {
      display: none;
    }
  </style>

</body>
</html>
